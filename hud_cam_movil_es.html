<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Sistema de Vigilancia • Visor IA</title>
<style>
  :root { --bg:#0b0f1a; --fg:#e5ecf3; --line:#2a3650; --accent:#3aa0ff; --warn:#ffb020; --ok:#19c37d; --violet:#7c3aed; }
  *{box-sizing:border-box} body{margin:0;background:#0b0f1a;color:var(--fg);font-family:ui-sans-serif,system-ui,Inter;overflow:hidden}
  /* Layout */
  .topbar{position:fixed;top:env(safe-area-inset-top,8px);left:8px;right:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--line);background:rgba(8,12,18,.8);backdrop-filter:blur(4px);border-radius:10px;z-index:1000}
  .brand{font-weight:700;letter-spacing:.04em}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;opacity:.95;display:flex;gap:6px;align-items:center}
  select,input[type=range],input[type=text]{background:#0f1626;color:var(--fg);border:1px solid #25324a;border-radius:8px;padding:7px 8px}
  button{background:#0f1626;color:var(--fg);border:1px solid #25324a;border-radius:8px;padding:8px 10px;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .stat{font-size:12px;opacity:.85}
  .stage{position:fixed;inset:0;display:grid;grid-template-columns:1fr 340px;gap:10px;padding:70px 8px 8px 8px}
  @media (max-width: 1024px){ .stage{grid-template-columns:1fr;grid-template-rows:1fr 42vh;gap:8px;padding:110px 8px 8px} }
  .view{position:relative;width:100%;height:100%;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#000}
  video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none}
  .fit-contain video,.fit-contain canvas{object-fit:contain}
  .hit{position:absolute;inset:0;pointer-events:auto}
  .roi{position:absolute;border:1.5px dashed var(--accent);background:rgba(58,160,255,.08);display:none}
  .ret{position:absolute;inset:0;pointer-events:none}
  .ret:before,.ret:after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border:1px solid #1e2942;border-radius:2px}
  .ret:before{width:38%;height:38%}
  .ret:after{width:12%;height:12%;border-color:#2b3b61}
  .scan{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(58,160,255,.6),transparent);animation:scan 3s linear infinite}
  @keyframes scan{0%{top:0}100%{top:100%}}
  /* Side panel */
  .side{border:1px solid var(--line);border-radius:10px;background:#0f1626;display:flex;flex-direction:column;overflow:hidden}
  .side h3{margin:10px 12px 6px;font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.8}
  .panel{flex:1;overflow:auto;border-top:1px solid #1b2740}
  .row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #141d32;font-size:13px}
  .row strong{font-weight:700}
  .row small{opacity:.8}
  .feed{height:34%;overflow:auto;border-top:1px solid #1b2740;font-size:12px}
  .feed .log{padding:6px 12px;border-bottom:1px solid #141d32;opacity:.9}
  /* Tags */
  .tag{position:absolute;transform:translate(-50%,-100%);background:rgba(9,13,24,.92);border:1px solid #2b3b61;border-radius:8px;padding:4px 8px;font-size:12px;white-space:nowrap;pointer-events:auto}
  .tag .id{opacity:.75;margin-right:6px}
  .tag .conf{opacity:.8}
  .tag.pinned{border-color:var(--violet)}
  /* Info card */
  .card{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);max-width:min(92vw,820px);background:#0f1626;border:1px solid var(--line);border-radius:10px;padding:10px 12px;z-index:1100}
  .card h4{margin:0 0 6px;font-size:15px}
  .card .meta{font-size:12px;opacity:.85}
  .chip{display:inline-block;border:1px solid #2b3b61;border-radius:999px;padding:3px 8px;margin:2px 6px 0 0;font-size:12px}
  .close{float:right;background:transparent;border:1px solid #25324a;border-radius:8px;padding:4px 8px}
  /* Toggles */
  .switch{display:inline-flex;align-items:center;gap:6px;border:1px solid #25324a;padding:6px 8px;border-radius:8px}
  .switch input{accent-color:#3aa0ff}
  /* Toast */
  .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#0f1626;border:1px solid var(--line);padding:7px 10px;border-radius:8px;z-index:1500;font-size:12px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">SISTEMA DE VIGILANCIA • Visor IA</div>
    <div class="controls">
      <select id="camera"></select>
      <label>Resolución
        <select id="res">
          <option>640x480</option><option selected>1280x720</option><option>1920x1080</option>
        </select>
      </label>
      <label>Encuadre
        <select id="fit"><option value="contain" selected>Ver todo</option><option value="cover">Llenar</option></select>
      </label>
      <button id="start">Iniciar</button>
      <button id="stop" disabled>Detener</button>

      <label>Detector
        <select id="detector">
          <option value="coco" selected>Local (COCO • 80)</option>
          <option value="pro">Pro (600+ • Roboflow)</option>
        </select>
      </label>
      <label id="rfBox" style="display:none">Modelo Pro
        <input id="rfModel" placeholder="p.ej. open-images/1" style="width:140px">
        <input id="rfKey" placeholder="API key" style="width:120px">
        <button id="rfSave">Guardar</button>
      </label>

      <label>Umbral
        <input id="th" type="range" min="0.05" max="0.95" step="0.01" value="0.35">
        <span id="thVal" class="stat">35% (↓=más detecciones / ↑=más preciso)</span>
      </label>

      <label>Frecuencia
        <select id="freq"><option>1</option><option selected>2</option><option>3</option><option>5</option></select>
      </label>

      <span class="switch"><input id="showTags" type="checkbox" checked>Etiquetas</span>
      <span class="switch"><input id="compact" type="checkbox">Compacto</span>
      <span class="switch"><input id="infoOnline" type="checkbox">Wikipedia</span>
      <span class="switch"><input id="torch" type="checkbox" disabled>Linterna</span>
      <span id="fps" class="stat">FPS: --</span>
      <span id="status" class="stat">Listo</span>
    </div>
  </div>

  <div class="stage">
    <!-- VIEW -->
    <div class="view fit-contain" id="view">
      <video id="video" playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="hit" id="hit"></div>
      <div class="roi" id="roi"></div>
      <div class="ret"></div>
      <div class="scan"></div>
    </div>

    <!-- SIDE -->
    <div class="side">
      <h3>Objetos</h3>
      <div class="panel" id="list"></div>
      <h3>Eventos</h3>
      <div class="feed" id="feed"></div>
    </div>
  </div>

  <!-- Info -->
  <div class="card" id="card" style="display:none"></div>
  <div class="toast" id="toast" style="display:none"></div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <!-- Roboflow SDK (opcional; sólo si activas modo Pro) -->
  <script src="https://cdn.roboflow.com/0.2.26/roboflow.js"></script>

<script>
(async function(){
  const $ = s => document.querySelector(s);
  const els = {
    cam: $('#camera'), res: $('#res'), fit: $('#fit'), start: $('#start'), stop: $('#stop'),
    detector: $('#detector'), rfBox: $('#rfBox'), rfModel: $('#rfModel'), rfKey: $('#rfKey'), rfSave: $('#rfSave'),
    th: $('#th'), thVal: $('#thVal'), freq: $('#freq'),
    showTags: $('#showTags'), compact: $('#compact'), infoOnline: $('#infoOnline'),
    torch: $('#torch'), fps: $('#fps'), status: $('#status'),
    view: $('#view'), video: $('#video'), canvas: $('#canvas'), hit: $('#hit'), roi: $('#roi'),
    list: $('#list'), feed: $('#feed'), card: $('#card'), toast: $('#toast')
  };
  const ctx = els.canvas.getContext('2d', { willReadFrequently:true });

  /* ---------- Estado ---------- */
  let stream=null, track=null, running=false, raf=0, model=null, rfModel=null;
  let latest=[], tracks=[], nextTrackId=1, prevStamp=performance.now();
  let roi=null; // {x,y,w,h} coords en canvas
  const CFG = { minSide: 18, alpha: 0.8, iouMatch: 0.25, maxTags: 12 };

  /* ---------- Util ---------- */
  const toast = (msg)=>{ els.toast.textContent=msg; els.toast.style.display='block'; clearTimeout(els.toast._t); els.toast._t=setTimeout(()=>els.toast.style.display='none',1600); };
  const log = (s)=>{ const div=document.createElement('div'); div.className='log'; div.textContent = `[${new Date().toLocaleTimeString()}] ${s}`; els.feed.prepend(div); };
  const parseRes = v => { const [w,h]=v.split('x').map(Number); return {width:w,height:h}; };
  const toES = (en)=>{ // base + alias corporativo
    const base = {
      person:'persona', bicycle:'bicicleta', car:'coche', motorcycle:'motocicleta', airplane:'avión', bus:'autobús', train:'tren', truck:'camión', boat:'barco',
      traffic_light:'semáforo', fire_hydrant:'hidrante', stop_sign:'señal de pare', parking_meter:'parquímetro', bench:'banco',
      bird:'pájaro', cat:'gato', dog:'perro', horse:'caballo', sheep:'oveja', cow:'vaca', elephant:'elefante', bear:'oso', zebra:'cebra', giraffe:'jirafa',
      backpack:'mochila', umbrella:'paraguas', handbag:'bolso', tie:'corbata', suitcase:'maleta', frisbee:'frisbi', skis:'esquís', snowboard:'tabla',
      sports_ball:'balón', kite:'cometa', baseball_bat:'bate', baseball_glove:'guante', skateboard:'patineta', surfboard:'tabla de surf', tennis_racket:'raqueta',
      bottle:'botella', wine_glass:'copa', cup:'taza', fork:'tenedor', knife:'cuchillo', spoon:'cuchara', bowl:'cuenco',
      banana:'banano', apple:'manzana', sandwich:'sándwich', orange:'naranja', broccoli:'brócoli', carrot:'zanahoria', hot_dog:'perro caliente', pizza:'pizza', donut:'dónut', cake:'torta',
      chair:'silla', couch:'sofá', potted_plant:'planta en maceta', bed:'cama', dining_table:'mesa', toilet:'inodoro', tv:'televisor',
      laptop:'portátil', mouse:'ratón', remote:'control remoto', keyboard:'teclado', cell_phone:'teléfono', microwave:'microondas', oven:'horno', toaster:'tostadora',
      sink:'lavamanos', refrigerator:'nevera', book:'libro', clock:'reloj', vase:'jarrón', scissors:'tijeras', teddy_bear:'oso de peluche', hair_drier:'secador', toothbrush:'cepillo de dientes'
    };
    const dict = JSON.parse(localStorage.getItem('aliasDict')||'{}');
    return dict[en] || base[en] || en.replace(/_/g,' ');
  };
  const pct = v => (v*100).toFixed(0)+'%';

  /* ---------- Detector plugins ---------- */
  const DET = {
    name:'coco',
    async load(){ this.m = await cocoSsd.load({ base: 'mobilenet_v2' }); },
    async infer(video){
      const out = await this.m.detect(video);
      return out.map(o=>({ cls:o.class, score:o.score, bbox:o.bbox })); // [x,y,w,h]
    }
  };

  const RF = {
    name:'pro',
    async load(){
      const cfg = getRF();
      if (!cfg.key || !cfg.model) throw new Error('Configura modelo/clave Roboflow');
      const [mName, mVer] = cfg.model.split('/');
      this.m = await window.roboflow.auth({ publishable_key: cfg.key }).load({ model: mName, version: parseInt(mVer||'1',10) });
    },
    async infer(video){
      const preds = await this.m.detect(video);
      // Roboflow -> x,y (centro), width,height
      return preds?.predictions?.map(p=>{
        return { cls: (p.class||p.top||'obj').toString(), score: p.confidence||p.score||0,
          bbox: [p.x - p.width/2, p.y - p.height/2, p.width, p.height] };
      }) || [];
    }
  };

  function getRF(){
    return {
      model: localStorage.getItem('rfModel')||'',
      key: localStorage.getItem('rfKey')||''
    };
  }

  /* ---------- Cámara ---------- */
  async function enumerateCams(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    const vids = devs.filter(d=>d.kind==='videoinput');
    els.cam.innerHTML = '';
    vids.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label || `Cámara ${i+1}`; els.cam.appendChild(o); });
  }

  async function startCam(){
    try{
      if (stream) stopCam();
      const deviceId = els.cam.value || undefined;
      const {width,height} = parseRes(els.res.value);
      stream = await navigator.mediaDevices.getUserMedia({
        video: deviceId ? { deviceId: {exact:deviceId}, width:{ideal:width}, height:{ideal:height} } :
                          { facingMode:'environment', width:{ideal:width}, height:{ideal:height} },
        audio:false
      });
      els.video.srcObject = stream; await els.video.play();
      track = stream.getVideoTracks()[0];
      setupTorch(track);
      resize();
      running=true; els.start.disabled=true; els.stop.disabled=false;
      log('Cámara iniciada');
      loop();
    }catch(e){ console.error(e); alert('No se pudo iniciar la cámara. Revisa permisos/HTTPS.'); }
  }
  function stopCam(){
    running=false; cancelAnimationFrame(raf);
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; }
    els.start.disabled=false; els.stop.disabled=true;
    log('Cámara detenida');
  }
  function resize(){
    const r = els.view.getBoundingClientRect();
    els.canvas.width = r.width * devicePixelRatio;
    els.canvas.height = r.height * devicePixelRatio;
    els.view.classList.toggle('fit-contain', els.fit.value==='contain');
  }
  window.addEventListener('resize', resize);

  async function setupTorch(track){
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if (caps.torch !== undefined){ els.torch.disabled=false; els.torch.onchange = async ()=>{ try{ await track.applyConstraints({advanced:[{torch:els.torch.checked}]}); }catch{} }; }
  }

  /* ---------- Tracking (IDs) ---------- */
  function IoU(a,b){
    const x1=Math.max(a.x,b.x), y1=Math.max(a.y,b.y);
    const x2=Math.min(a.x+a.w,b.x+b.w), y2=Math.min(a.y+a.h,b.y+b.h);
    const inter=Math.max(0,x2-x1)*Math.max(0,y2-y1);
    const ua=a.w*a.h + b.w*b.h - inter; return ua>0 ? inter/ua : 0;
  }
  function updateTracks(dets){ // dets: {cls,score,bbox:[x,y,w,h]}
    // proyección a objetos con coords y suavizado
    const curr = dets.map(d=>({ cls:d.cls, score:d.score, x:d.bbox[0], y:d.bbox[1], w:d.bbox[2], h:d.bbox[3], id:null }));
    // ROI filtro
    if (roi){
      for (let i=curr.length-1;i>=0;i--){
        const a=curr[i]; const cx=a.x+a.w/2, cy=a.y+a.h/2;
        if (!(cx>=roi.x && cx<=roi.x+roi.w && cy>=roi.y && cy<=roi.y+roi.h)) curr.splice(i,1);
      }
    }
    // asociar por IoU
    const used = new Set();
    tracks.forEach(t=>{
      let best=-1, bestI= -1;
      curr.forEach((c,i)=>{ if (used.has(i) || c.cls!==t.cls) return;
        const iou=IoU(t,c); if (iou>best){ best=iou; bestI=i; }});
      if (best>=CFG.iouMatch && bestI>-1){
        const c=curr[bestI]; // suavizado
        t.x = CFG.alpha*t.x + (1-CFG.alpha)*c.x;
        t.y = CFG.alpha*t.y + (1-CFG.alpha)*c.y;
        t.w = CFG.alpha*t.w + (1-CFG.alpha)*c.w;
        t.h = CFG.alpha*t.h + (1-CFG.alpha)*c.h;
        t.score = c.score; t.missed = 0; used.add(bestI);
      } else {
        t.missed++;
      }
    });
    // nuevos
    curr.forEach((c,i)=>{ if (used.has(i)) return;
      tracks.push({ id: nextTrackId++, cls:c.cls, x:c.x, y:c.y, w:c.w, h:c.h, score:c.score, missed:0 });
    });
    // limpiar perdidos
    tracks = tracks.filter(t=>t.missed<=8);
  }

  /* ---------- Detección principal ---------- */
  async function ensureModel(){
    try{
      if (els.detector.value==='pro'){
        els.rfBox.style.display='inline-flex';
        if (!rfModel){ await RF.load(); els.status.textContent='Detector Pro cargado'; rfModel=RF; model=null; }
      } else {
        els.rfBox.style.display='none';
        if (!model){ await tf.setBackend('webgl'); await tf.ready(); await DET.load(); els.status.textContent='Detector COCO cargado'; model=DET; rfModel=null; }
      }
    }catch(e){ console.error(e); toast('Error cargando detector'); els.status.textContent='Error de detector'; }
  }

  function draw(){
    const vw=els.canvas.width, vh=els.canvas.height;
    ctx.clearRect(0,0,vw,vh);
    // ROI
    if (roi){ ctx.strokeStyle='rgba(58,160,255,.8)'; ctx.setLineDash([8,6]); ctx.lineWidth=2; ctx.strokeRect(roi.x,roi.y,roi.w,roi.h); ctx.setLineDash([]); }
    // Dibujo de tracks
    els.list.innerHTML='';
    const max = CFG.maxTags;
    const sorted = tracks.slice().sort((a,b)=>b.score-a.score).slice(0,max);
    sorted.forEach(t=>{
      ctx.lineWidth = 2 * devicePixelRatio;
      ctx.strokeStyle = 'rgba(58,160,255,.9)';
      ctx.setLineDash([10*devicePixelRatio, 6*devicePixelRatio]);
      ctx.strokeRect(t.x, t.y, t.w, t.h);
      ctx.setLineDash([]);

      // tag
      if (els.showTags.checked){
        const id = t.id;
        let tag = document.getElementById('tag-'+id);
        if (!tag){ tag = document.createElement('div'); tag.className='tag'; tag.id='tag-'+id; tag.addEventListener('click',()=> openInfo(t)); els.view.appendChild(tag); }
        tag.classList.toggle('pinned', false);
        tag.classList.toggle('compact', els.compact.checked);
        tag.style.left = ((t.x + t.w/2)/devicePixelRatio) + 'px';
        tag.style.top  = (t.y/devicePixelRatio) + 'px';
        const label = toES(t.cls);
        tag.innerHTML = `<span class="id">#${id}</span><strong>${label}</strong> <span class="conf">${pct(t.score)}</span>`;
      }

      // panel
      const label = toES(t.cls);
      const rel = Math.round((t.w*t.h)/(vw*vh)*100);
      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `<div><strong>${label}</strong> <small>#${t.id}</small></div><div><small>${pct(t.score)} • ${rel}% área</small> <button data-id="${t.id}" class="btnInfo">Info</button></div>`;
      els.list.appendChild(row);
    });
    // limpiar tags huérfanos
    [...document.querySelectorAll('.tag')].forEach(el=>{
      const id = Number(el.id.replace('tag-','')); if (!tracks.find(t=>t.id===id)) el.remove();
    });

    // botones info
    els.list.querySelectorAll('.btnInfo').forEach(b=>{
      b.onclick = ()=>{ const id=Number(b.getAttribute('data-id')); const t=tracks.find(x=>x.id===id); if (t) openInfo(t); };
    });
  }

  async function openInfo(t){
    const labelES = toES(t.cls);
    let sum = `${labelES}. Objeto detectado con ${pct(t.score)} de confianza.`;
    let url = null;

    if (els.infoOnline.checked){
      try{
        const sURL = `https://es.wikipedia.org/w/rest.php/v1/search/title?q=${encodeURIComponent(labelES)}&limit=1`;
        const s = await fetch(sURL,{headers:{'Accept':'application/json'}}).then(r=>r.json());
        const title = (s?.pages && s.pages[0]?.title) ? s.pages[0].title : labelES;
        const sumURL = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const d = await fetch(sumURL,{headers:{'Accept':'application/json'}}).then(r=>r.json());
        sum = d?.extract || sum; url = d?.content_urls?.desktop?.page || d?.content_urls?.mobile?.page || null;
      }catch{}
    }

    const meta = `ID #${t.id} • ${toES(t.cls)} • Confianza ${pct(t.score)} • Tamaño ${(t.w|0)}×${(t.h|0)}px`;
    els.card.style.display='block';
    els.card.innerHTML = `<button class="close" id="cclose">Cerrar</button><h4>${labelES}</h4><div class="meta">${meta}</div><div style="margin-top:6px">${sum}</div>${url?`<div style="margin-top:6px"><a class="chip" target="_blank" rel="noopener" href="${url}">Wikipedia</a></div>`:''}`;
    $('#cclose').onclick = ()=> els.card.style.display='none';
  }

  /* ---------- ROI (zona de interés) ---------- */
  let drag=null;
  els.hit.addEventListener('mousedown', e=> startDrag(e));
  els.hit.addEventListener('touchstart', e=> startDrag(e.touches[0]));
  function startDrag(e){
    const r=els.canvas.getBoundingClientRect();
    drag = { x0:(e.clientX-r.left)*devicePixelRatio, y0:(e.clientY-r.top)*devicePixelRatio };
    els.roi.style.display='block';
  }
  window.addEventListener('mousemove', e=> moveDrag(e));
  window.addEventListener('touchmove', e=>{ if (e.touches[0]) moveDrag(e.touches[0]); }, {passive:true});
  function moveDrag(e){
    if (!drag) return;
    const r=els.canvas.getBoundingClientRect();
    const x=(e.clientX-r.left)*devicePixelRatio, y=(e.clientY-r.top)*devicePixelRatio;
    const x1=Math.min(drag.x0,x), y1=Math.min(drag.y0,y), w=Math.abs(x-drag.x0), h=Math.abs(y-drag.y0);
    roi = {x:x1,y:y1,w,h};
    Object.assign(els.roi.style,{left:(x1/devicePixelRatio)+'px',top:(y1/devicePixelRatio)+'px',width:(w/devicePixelRatio)+'px',height:(h/devicePixelRatio)+'px'});
  }
  window.addEventListener('mouseup', ()=> endDrag());
  window.addEventListener('touchend', ()=> endDrag());
  function endDrag(){ if (!drag) return; drag=null; log('ROI ajustada'); }

  /* ---------- Bucle ---------- */
  async function loop(){
    if (!running) return;
    const skip = parseInt(els.freq.value||'2',10);
    // FPS
    const now=performance.now(); const dt=now-prevStamp; prevStamp=now; const fps=Math.round(1000/dt); if (Number.isFinite(fps)) els.fps.textContent='FPS: '+fps;

    if (!((now|0)%skip)){ /* noop */ }
    const th = parseFloat(els.th.value||'0.35');
    try{
      const det = rfModel || model;
      const raw = await det.infer(els.video);
      // filtrar por umbral y tamaño
      const min = CFG.minSide*devicePixelRatio;
      const filtered = raw.filter(p=> p.score>=th && p.bbox[2]>=min && p.bbox[3]>=min);
      latest = filtered;
      updateTracks(filtered);
      draw();
    }catch(e){ /* caída temporal ok */ }

    raf = requestAnimationFrame(loop);
  }

  /* ---------- Init ---------- */
  function saveRF(){ localStorage.setItem('rfModel', els.rfModel.value.trim()); localStorage.setItem('rfKey', els.rfKey.value.trim()); toast('Config Pro guardada'); }

  // UI
  els.detector.onchange = async ()=>{
    els.rfBox.style.display = els.detector.value==='pro' ? 'inline-flex' : 'none';
    model = null; rfModel = null; await ensureModel();
  };
  els.rfSave.onclick = saveRF;

  els.start.onclick = async ()=>{ await ensureModel(); await startCam(); };
  els.stop.onclick = stopCam;

  els.th.oninput = ()=> els.thVal.textContent = `${Math.round(parseFloat(els.th.value)*100)}% (↓=más detecciones / ↑=más preciso)`;
  els.fit.onchange = ()=> resize();
  els.res.onchange = async ()=> { if (running) await startCam(); };
  els.showTags.onchange = ()=>{ document.body.classList.toggle('hideTags', !els.showTags.checked); };
  els.compact.onchange = ()=>{
    document.querySelectorAll('.tag').forEach(t=> t.classList.toggle('compact', els.compact.checked));
  };

  try{
    const tmp = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    tmp.getTracks().forEach(t=>t.stop());
    await enumerateCams();
  }catch{ await enumerateCams(); }

  // Prefill RF config
  els.rfModel.value = localStorage.getItem('rfModel')||'';
  els.rfKey.value = localStorage.getItem('rfKey')||'';

  // Fit inicial
  resize();
  els.status.textContent = 'Listo';
})();
</script>
</body>
</html>
